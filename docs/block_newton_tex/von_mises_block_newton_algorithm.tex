\documentclass{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{tcolorbox}
\usepackage[margin=1in]{geometry}

\title{von Mises Block Newton Algorithm Implementation}
\author{Based on Yamamoto et al. (2021)}
\date{\today}

\begin{document}
\maketitle

\section{Block Newton Method for von Mises Elastoplasticity}

The following boxes describe the implementation of the Block Newton method for von Mises elastoplasticity with Voce hardening, as implemented in \texttt{stress\_vm\_bn.f}.

\begin{tcolorbox}[colback=blue!5!white,colframe=blue!75!black,title=\textbf{BOX 1: Main Algorithm for von Mises Block Newton}]
\textbf{Processed in:} \texttt{stress\_vm\_bn.f} (lines 108-313)\\
\textbf{Input:} Trial strain $\boldsymbol{\varepsilon}^{\text{tr}}_{n+1}$, previous state variables $(\boldsymbol{\varepsilon}^p_n, \alpha_n, \boldsymbol{\beta}_n)$, iteration $k$\\
\textbf{Output:} Updated stress $\boldsymbol{\sigma}_{n+1}^{(k)}$, tangent modulus $\mathbb{C}^{\text{ep}}$, yield function $g^{(k)}$

\begin{algorithmic}[1]
\STATE \textbf{Step 1: Compute trial stress}
\begin{align}
\boldsymbol{s}^{\text{tr}} &= 2\mu(\boldsymbol{\varepsilon}_{n+1} - \frac{1}{3}\text{tr}(\boldsymbol{\varepsilon}_{n+1})\boldsymbol{I} - \boldsymbol{\varepsilon}^p_n)\\
\boldsymbol{\xi}^{\text{tr}} &= \boldsymbol{s}^{\text{tr}} - \boldsymbol{\beta}_n\\
f^{\text{tr}} &= \|\boldsymbol{\xi}^{\text{tr}}\| - \sqrt{\frac{2}{3}}(\sigma_Y + K(\alpha_n))
\end{align}

\STATE \textbf{Step 2: Determine plastic loading}
\IF{$f^{\text{tr}} \leq -\text{tol}$}
    \STATE Elastic step: $\Delta\gamma = 0$, $g = 0$
    \STATE $\boldsymbol{\sigma}_{n+1} = \boldsymbol{s}^{\text{tr}} + \kappa\text{tr}(\boldsymbol{\varepsilon}_{n+1})\boldsymbol{I}$
    \STATE $\mathbb{C}^{\text{ep}} = \mathbb{C}^e$
\ELSE
    \STATE Plastic step: proceed to Step 3
\ENDIF

\STATE \textbf{Step 3: Update consistency parameter}
\IF{$k = 0$ (first iteration)}
    \STATE Initialize using BOX 2
\ELSE
    \STATE Update $\Delta\gamma^{(k+1)} = \Delta\gamma^{(k)} + \delta\gamma$
    \STATE where $\delta\gamma$ is computed from global system
\ENDIF

\STATE \textbf{Step 4: Update state variables}
\begin{align}
\alpha_{n+1}^{(k)} &= \alpha_n + \sqrt{\frac{2}{3}}\Delta\gamma^{(k)}\\
\boldsymbol{n}^{(k)} &= \frac{\boldsymbol{\xi}^{(k)}}{\|\boldsymbol{\xi}^{(k)}\|}\\
\boldsymbol{\varepsilon}^{p(k)}_{n+1} &= \boldsymbol{\varepsilon}^p_n + \Delta\gamma^{(k)}\boldsymbol{n}^{(k)}\\
\boldsymbol{\beta}^{(k)}_{n+1} &= \boldsymbol{\beta}_n + \frac{2}{3}K'(\alpha_{n+1}^{(k)})\Delta\gamma^{(k)}\boldsymbol{n}^{(k)}
\end{align}

\STATE \textbf{Step 5: Update stress and compute yield function}
\begin{align}
\boldsymbol{\sigma}_{n+1}^{(k)} &= \boldsymbol{s}^{\text{tr}} - 2\mu\Delta\gamma^{(k)}\boldsymbol{n}^{(k)} + \kappa\text{tr}(\boldsymbol{\varepsilon}_{n+1})\boldsymbol{I}\\
\boldsymbol{\xi}^{(k)} &= \text{dev}(\boldsymbol{\sigma}_{n+1}^{(k)}) - \boldsymbol{\beta}^{(k)}_{n+1}\\
g^{(k)} &= \|\boldsymbol{\xi}^{(k)}\| - \sqrt{\frac{2}{3}}(\sigma_Y + K(\alpha_{n+1}^{(k)}))
\end{align}

\STATE \textbf{Step 6: Compute tangent modulus}
\begin{align}
\boldsymbol{L} &= -2\mu\boldsymbol{n}^{(k)}\\
\boldsymbol{M} &= 2\mu\boldsymbol{n}^{(k)}\\
N &= -(2\mu + \frac{2}{3}K'(\alpha_{n+1}^{(k)}))\\
\mathbb{C}^{\text{ep}} &= \mathbb{C}^e - \frac{1}{N}\boldsymbol{L} \otimes \boldsymbol{M}
\end{align}
\end{algorithmic}
\end{tcolorbox}

\begin{tcolorbox}[colback=green!5!white,colframe=green!75!black,title=\textbf{BOX 2: Initialization ($k=0$)}]
\textbf{Processed in:} \texttt{stress\_vm\_bn.f} (lines 147-189)\\
\textbf{Purpose:} Initialize variables for the first iteration of Block Newton method

\begin{algorithmic}[1]
\STATE \textbf{Step 1: Set initial consistency parameter}
$$\Delta\gamma^{(0)} = 0$$

\STATE \textbf{Step 2: Compute initial stress (elastic predictor)}
$$\boldsymbol{\sigma}_{n+1}^{(0)} = \boldsymbol{s}^{\text{tr}} + \kappa\text{tr}(\boldsymbol{\varepsilon}_{n+1})\boldsymbol{I}$$

\STATE \textbf{Step 3: Evaluate initial yield function}
\begin{align}
\boldsymbol{s}^{(0)} &= \text{dev}(\boldsymbol{\sigma}_{n+1}^{(0)})\\
\boldsymbol{\xi}^{(0)} &= \boldsymbol{s}^{(0)} - \boldsymbol{\beta}_n\\
g^{(0)} &= \|\boldsymbol{\xi}^{(0)}\| - \sqrt{\frac{2}{3}}(\sigma_Y + K(\alpha_n))
\end{align}

\STATE \textbf{Step 4: Set initial plastic variables}
\begin{align}
\boldsymbol{\varepsilon}^{p(0)}_{n+1} &= \boldsymbol{\varepsilon}^p_n\\
\alpha^{(0)}_{n+1} &= \alpha_n\\
\boldsymbol{\beta}^{(0)}_{n+1} &= \boldsymbol{\beta}_n
\end{align}

\STATE \textbf{Step 5: Compute initial flow direction}
$$\boldsymbol{n}^{(0)} = \frac{\boldsymbol{\xi}^{(0)}}{\|\boldsymbol{\xi}^{(0)}\|}$$

\STATE \textbf{Step 6: Initialize matrices for tangent computation}
\begin{align}
\boldsymbol{L}^{(0)} &= -2\mu\boldsymbol{n}^{(0)}\\
\boldsymbol{M}^{(0)} &= 2\mu\boldsymbol{n}^{(0)}\\
N^{(0)} &= -(2\mu + \frac{2}{3}K'(\alpha_n))
\end{align}
\end{algorithmic}
\end{tcolorbox}

\section{Key Differences from Return Mapping}

\begin{enumerate}
\item \textbf{No local iterations}: The consistency parameter $\Delta\gamma$ is updated directly from the global Newton iteration through $\delta\gamma$.
\item \textbf{Coupled solution}: The yield condition $g = 0$ is enforced simultaneously with equilibrium $\boldsymbol{R}_f = 0$.
\item \textbf{Consistent tangent}: The elastoplastic tangent modulus is computed at each global iteration.
\end{enumerate}

\section{Implementation Details}

\subsection{Source Files and Processing Locations}
\begin{itemize}
\item \texttt{stress\_vm\_bn.f} (lines 1-408): Main stress update routine for von Mises Block Newton
  \begin{itemize}
  \item Lines 108-143: Trial stress computation and yield check
  \item Lines 147-189: BOX 2 initialization for first iteration
  \item Lines 191-221: State variable updates for iterations k>0
  \item Lines 233-282: Tangent modulus computation
  \end{itemize}
\item \texttt{phexa8.f} (lines 288-349): Element routine handling global coupling
  \begin{itemize}
  \item Lines 295-343: $\delta\gamma$ computation for von Mises (MATYPE=6)
  \item Lines 302-310: Strain increment calculation
  \item Lines 329-335: Newton increment formula
  \end{itemize}
\item \texttt{analys.f} (lines 380-491): Main analysis routine
  \begin{itemize}
  \item Lines 388-392: Call to postpr for stress integration
  \item Lines 488-491: Convergence check for Block Newton
  \item Lines 526-542: Output routine call with g\_norm
  \end{itemize}
\item \texttt{postpr.f} (lines 194-198): Post-processing
  \begin{itemize}
  \item Lines 194-198: Collection of g\_vals for norm computation
  \end{itemize}
\end{itemize}

\subsection{Material Parameters (from stress\_vm\_bn.f lines 89-101)}
\begin{itemize}
\item Young's modulus: $E$ = \texttt{prope(1)}
\item Poisson's ratio: $\nu$ = \texttt{prope(2)}
\item Initial yield stress: $\sigma_Y$ = \texttt{prope(10)}
\item Linear hardening coefficient: $h_k$ = \texttt{prope(11)}
\item Voce saturation stress: $h_{pa}$ = \texttt{prope(12)}
\item Voce hardening exponent: $h_{pb}$ = \texttt{prope(13)}
\item Hardening scale factor: $h_{pd}$ = \texttt{prope(15)}
\end{itemize}

\subsection{Voce Hardening Function}
$$K(\alpha) = h_{pd} \left[ h_k \alpha + (h_{pa} - \sigma_Y)(1 - e^{-h_{pb}\alpha}) \right]$$

\subsection{Global System Coupling}
The increment $\delta\gamma$ is computed in \texttt{phexa8.f} (lines 295-343) using:
$$\delta\gamma = -\frac{1}{N}\left(\boldsymbol{M}:\Delta\boldsymbol{\varepsilon} + g^{(k-1)}\right)$$
where $\Delta\boldsymbol{\varepsilon} = \boldsymbol{\varepsilon}^{(k)} - \boldsymbol{\varepsilon}^{(k-1)}$ is the strain increment between global iterations.

\subsection{Convergence Criteria (checked in analys.f lines 488-491)}
The Block Newton method achieves convergence when both:
\begin{enumerate}
\item Equilibrium: $\|\boldsymbol{R}_f\|/\|\boldsymbol{F}\| < \text{tol}$
\item Yield condition: $\|g\| < \text{tol}$
\end{enumerate}

\end{document}