# stress.f 変数説明書

## 概要
`stress.f`は、Drucker-Pragerモデルに基づく弾塑性構成則を実装したサブルーチンです。このファイルでは、弾性・塑性変形の計算、降伏判定、硬化則の処理を行います。入力・出力のデータ構造は[CMLフォーマット](CMLformat07.md)に基づいており、詳細なフォーマット仕様については同ファイルを参照してください。

## 入力引数

| 変数名 | 型 | 次元 | 説明 |
|--------|---|------|------|
| `itrmax` | integer | スカラー | Newton-Raphson反復計算の最大回数 |
| `idepg` | integer | スカラー | 塑性状態フラグ（0:弾性、1:塑性） |
| `prope` | real*8 | (20) | 材料定数配列 |
| `sig` | real*8 | (3,3) | 応力テンソル |
| `str` | real*8 | (3,3) | ひずみテンソル |
| `ehist` | real*8 | (20) | 履歴変数配列 |
| `ctol` | real*8 | スカラー | 収束判定許容値 |

## 出力引数

| 変数名 | 型 | 次元 | 説明 |
|--------|---|------|------|
| `vons` | real*8 | スカラー | von Mises応力 |
| `e_dns` | real*8 | スカラー | 弾性ひずみエネルギー密度 |
| `p_dns` | real*8 | スカラー | 塑性ひずみエネルギー密度 |
| `ctens` | real*8 | (3,3,3,3) | 接線剛性テンソル |
| `ierror` | integer | スカラー | エラーフラグ |

## 材料定数（prope配列）

| インデックス | 変数名 | 説明 |
|-------------|--------|------|
| `prope(1)` | `yng` | ヤング率 |
| `prope(2)` | `poi` | ポアソン比 |
| `prope(3)` | `row` | 密度 |
| `prope(4)` | `ccc` | 比熱 |
| `prope(5)` | `aaa` | 熱膨張係数 |
| `prope(10)` | `yld` | 初期降伏応力（c₀） |
| `prope(11)` | `hk` | 硬化係数（H̄） |
| `prope(12)` | `hpa` | 飽和硬化応力（H̄∞） |
| `prope(13)` | `hpb` | 硬化減衰率（ξ̄） |
| `prope(15)` | `hpd` | 等方・移動硬化分配パラメータ（θ, [0,1]） |
| `prope(16)` | `phi_dp` | 内部摩擦角 |
| `prope(17)` | `psi_dp` | ダイレタンシー角 |

## 弾性定数

| 変数名 | 説明 | 計算式 |
|--------|------|--------|
| `vmu` | せん断弾性係数 | E / (2(1+ν)) |
| `vlm` | ラメ定数λ | νE / ((1+ν)(1-2ν)) |
| `vkp` | 体積弾性係数 | E / (3(1-2ν)) |

## Drucker-Prager パラメータ

| 変数名 | 説明 | 計算式 |
|--------|------|--------|
| `eta_dp` | 降伏関数パラメータη | sin(φ) / (√3(3-sin(φ))) |
| `xi_dp` | 降伏関数パラメータξ | 6cos(φ) / (√3(3-sin(φ))) |
| `etabar_dp` | 塑性ポテンシャル パラメータη̄ | 6sin(ψ) / (√3(3-sin(ψ))) |

## ひずみ・応力テンソル

| 変数名 | 型 | 次元 | 説明 |
|--------|---|------|------|
| `str` | real*8 | (3,3) | 全ひずみテンソル |
| `stry` | real*8 | (3,3) | 試行偏差応力テンソル |
| `seta` | real*8 | (3,3) | 試行相当応力テンソル |
| `sig` | real*8 | (3,3) | 応力テンソル |
| `oun` | real*8 | (3,3) | 応力空間での外向き単位法線ベクトル |
| `sd` | real*8 | (3,3) | 偏差応力テンソル |
| `eel` | real*8 | (3,3) | 弾性ひずみテンソル |
| `plstrg` | real*8 | (3,3) | 塑性ひずみテンソル |
| `betaeg` | real*8 | (3,3) | 背応力テンソル（移動硬化） |

## スカラー変数

### 基本変数
| 変数名 | 説明 |
|--------|------|
| `emean` | ひずみテンソルの平均値（体積ひずみ/3） |
| `ptry` | 試行静水圧応力成分 |
| `stno` | 試行相当応力のノルム |
| `smean` | 応力テンソルの平均値（静水圧応力） |
| `etrs` | ひずみテンソルのトレース（体積ひずみ） |

### 塑性変数
| 変数名 | 説明 |
|--------|------|
| `alpeg` | 相当塑性ひずみ |
| `deltag` | 塑性乗数増分（Δγ） |
| `alptmp` | 一時的な相当塑性ひずみ |
| `alpd` | 相当塑性ひずみ増分 |

### 硬化関数
| 変数名 | 説明 |
|--------|------|
| `hard` | 等方硬化関数 |
| `hrdtmp` | 一時的な等方硬化関数値 |
| `dhdtmp` | 等方硬化関数の微分 |
| `tmpkrd` | 移動硬化項の増分 |
| `dkdtmp` | 移動硬化関数の微分 |
| `dhard` | 等方硬化関数の微分（更新後） |
| `dkard` | 移動硬化関数の微分（更新後） |

### 降伏・収束判定
| 変数名 | 説明 |
|--------|------|
| `ftreg` | 降伏関数値 |
| `gg` | Newton-Raphson法の残差 |
| `Dg` | Newton-Raphson法のヤコビアン |

### 接線剛性関連
| 変数名 | 説明 |
|--------|------|
| `A` | コンシステント接線剛性のスカラー係数 |
| `theta` | 接線剛性計算用パラメータ |
| `thetab` | 接線剛性計算用パラメータ |

## テンソル演算子（共通ブロック）

| 変数名 | 型 | 次元 | 説明 |
|--------|---|------|------|
| `DELTA` | real*8 | (3,3) | クロネッカーのデルタ（単位テンソル） |
| `EPSLN` | real*8 | (3,3,3) | 置換テンソル |
| `FIT` | real*8 | (3,3,3,3) | 4次単位テンソル |
| `DTENS` | real*8 | (3,3,3,3) | 偏差演算子 |

## 流動則と塑性ポテンシャル

| 変数名 | 型 | 次元 | 説明 |
|--------|---|------|------|
| `N` | real*8 | (3,3) | 塑性流動方向（非関連流動則用） |

## 履歴変数（ehist配列）

| インデックス | 内容 |
|-------------|------|
| `ehist(1)` | 相当塑性ひずみ（alpeg） |
| `ehist(2-10)` | 塑性ひずみテンソル成分（plstrg） |
| `ehist(11-19)` | 背応力テンソル成分（betaeg） |
| `ehist(20)` | 予備 |

## 主要な計算手順

1. **履歴変数の読み込み**: `ehist`から前ステップの塑性状態を復元
2. **試行応力の計算**: 弾性予測による試行応力を算出
3. **降伏判定**: 降伏関数により弾塑性状態を判定
4. **塑性乗数の決定**: Newton-Raphson法により塑性乗数を計算
5. **応力・内部変数の更新**: 塑性流動則に基づく状態更新
6. **接線剛性の計算**: コンシステント接線剛性テンソルの構築
7. **履歴変数の保存**: 次ステップ用の状態変数を保存

## エラーコード

| コード | 説明 |
|--------|------|
| `ierror = 17` | Newton-Raphson法が収束しない（塑性乗数計算失敗） |
| `ierror = 21` | 2×2ヤコビ行列が特異（det ≈ 0） |

## `stress_dp.f` 変数説明

`stress_dp.f` は 2 変数の Newton–Raphson 法を用いた
Drunker–Prager 模型の応力更新ルーチンです。インターフェースは次の
通りです。

```fortran
subroutine stress_dp(str, sig, ctens, ehist, ierror)
```

### 引数

| 変数名 | 型 | 次元 | 説明 |
|--------|---|------|------|
| `str`  | real*8 | (3,3) | 全ひずみテンソル |
| `sig`  | real*8 | (3,3) | 応力テンソル（出力） |
| `ctens`| real*8 | (3,3,3,3) | 接線剛性テンソル（出力） |
| `ehist`| real*8 | (19) | 履歴変数配列 (入力/出力) |
| `ierror`| integer | スカラー | エラーフラグ |

### 主な内部変数

`stress.f` と共通の変数に加え，以下の変数を用います。

| 変数名 | 型 | 説明 |
|--------|---|------|
| `R(2)` | real*8 | 2×2 Newton–Raphson 法の残差ベクトル |
| `dR(2,2)` | real*8 | 残差のヤコビアン行列 |
| `dx(2)` | real*8 | 未知量の更新量 `Δγ` と `σ_eq` |
| `sig_eq` | real*8 | 等価応力（未知量） |
| `sig_eq_trial` | real*8 | 試行等価応力 |
| `det` | real*8 | 2×2 行列式（Newton–Raphson 解） |

### 2 変数 Newton–Raphson 法

`stress_dp.f` では塑性乗数 `Δγ` と等価応力 `σ_eq` を同時に求めるため，
2×2 の非線形方程式を解きます。`stress.f` が 1 変数 (`Δγ`) のみを
反復するのに対し，`stress_dp.f` は応力更新の安定化を目的に 2 変数を
未知とする点が異なります。
ヤコビ行列が特異となる場合に備え，行列式の絶対値が
`TOL_DET = 1.0d-12` 以下であればエラーコード 21 を返して脱出します。
